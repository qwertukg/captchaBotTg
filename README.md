# README

# Капча-бот для Telegram на Kotlin

Данный проект представляет собой Telegram-бота, который автоматически проверяет новых участников чата с помощью капчи. Бот отправляет пользователю изображение с вопросом и вариантами ответа. Если пользователь отвечает правильно, ему предоставляется доступ к чату. В противном случае количество попыток уменьшается, и при исчерпании попыток пользователь блокируется на определенное время.

## Особенности

- **Капча с изображениями**: Бот отправляет пользователю изображение с несколькими вариантами, среди которых нужно выбрать правильный.
- **Ограничение доступа**: Новый пользователь не может отправлять сообщения в чат до успешного прохождения капчи.
- **Настраиваемое количество попыток**: Администратор может задать количество попыток для прохождения капчи.
- **Блокировка пользователей**: При исчерпании попыток пользователь блокируется на заданное время.
- **Логирование действий пользователя**: Бот ведет логирование действий пользователей, таких как попытки прохождения капчи.

## Требования

- **Kotlin**: Версия 1.5 или выше.
- **Telegram Bot API**: Библиотека `kotlin-telegram-bot` для взаимодействия с Telegram API.
- **Java**: Для работы с изображениями используется стандартная библиотека Java `java.awt`.

## Установка

1. **Клонируйте репозиторий:**

   ```bash
   git clone https://github.com/yourusername/telegram-captcha-bot.git
   ```

2. **Перейдите в директорию проекта:**

   ```bash
   cd telegram-captcha-bot
   ```

3. **Настройте переменные окружения:**

   Создайте файл `.env` в корне проекта и укажите следующие переменные:

   ```env
   BOT_TOKEN=ваш_токен_бота
   QUESTION=Ваш вопрос для капчи
   IMAGES_PATH=путь/к/папке/с/изображениями
   ATTEMPTS=3
   COLUMNS_COUNT=3
   BAN_TIME_SECONDS=3600
   ```

    - `BOT_TOKEN`: Токен вашего Telegram-бота, полученный от [BotFather](https://t.me/BotFather).
    - `QUESTION`: Вопрос, который будет задан пользователю в капче.
    - `IMAGES_PATH`: Путь к папке с изображениями для капчи.
    - `ATTEMPTS`: Максимальное количество попыток для прохождения капчи.
    - `COLUMNS_COUNT`: Количество столбцов при отображении вариантов ответов.
    - `BAN_TIME_SECONDS`: Время блокировки пользователя в секундах при исчерпании попыток.

4. **Установите зависимости:**

   Убедитесь, что у вас настроен Gradle или Maven для управления зависимостями. Добавьте в файл `build.gradle` или `pom.xml` зависимости для `kotlin-telegram-bot`.

5. **Подготовьте изображения:**

    - В папке, указанной в `IMAGES_PATH`, разместите изображения для капчи.
    - Назовите одно из изображений с суффиксом `_correct`, чтобы бот мог определить правильный вариант.

      Например:

      ```
      image1_correct.png
      image2.png
      image3.png
      ```

## Запуск

1. **Скомпилируйте проект:**

   ```bash
   ./gradlew build
   ```

2. **Запустите бота:**

   ```bash
   java -jar build/libs/telegram-captcha-bot.jar
   ```

## Использование

- Добавьте бота в ваш Telegram-чат с правами администратора, чтобы он мог ограничивать и блокировать пользователей.
- Когда новый пользователь присоединяется к чату, бот автоматически отправит ему капчу.
- Пользователь должен выбрать правильный вариант, нажав на соответствующую кнопку.
- Если пользователь отвечает правильно, ему предоставляется доступ к чату.
- Если пользователь исчерпывает все попытки, он блокируется на заданное время.

## Логирование

- Бот использует `java.util.logging.Logger` для логирования действий пользователей.
- Логируются следующие действия:
    - Присоединение пользователя к чату.
    - Нажатие пользователем на кнопку с вариантом ответа.
    - Выбор ответа пользователем.
    - Успешное прохождение капчи.
    - Неправильный ответ и блокировка пользователя.

## Настройка

- **Изменение вопроса капчи:**

  Измените переменную `QUESTION` в файле `.env` на желаемый вопрос.

- **Изменение количества попыток:**

  Измените значение `ATTEMPTS` в файле `.env`.

- **Изменение времени блокировки:**

  Измените значение `BAN_TIME_SECONDS` в файле `.env`.

- **Изменение количества вариантов в строке:**

  Измените значение `COLUMNS_COUNT` в файле `.env`.

## Структура проекта

- `main.kt`: Главный файл, содержащий точку входа и инициализацию бота.
- `CaptchaManager`: Класс, отвечающий за логику капчи и взаимодействие с пользователем.
- `UserCaptchaState`: Класс для хранения состояния пользователя.
- `Image`: Класс для хранения информации об изображении.

## Обработка изображений

- Бот автоматически обрабатывает изображения из указанной папки.
- Каждое изображение изменяется:
    - Приводится к размеру 200x200 пикселей.
    - Добавляется черная рамка.
    - В левом верхнем углу наносится номер изображения красным цветом.
- Изображения комбинируются в одно для отправки пользователю.

## Требования к изображениям

- Изображения должны быть в формате PNG или JPG.
- Одно из изображений должно быть названо с суффиксом `_correct` для определения правильного варианта.

## Пример использования

1. **Пользователь присоединяется к чату.**
2. **Бот отправляет капчу:**

    - Отображается изображение с вопросом и вариантами ответов.
    - Под изображением расположены кнопки с номерами вариантов.

3. **Пользователь выбирает вариант:**

    - Если ответ верный, бот приветствует пользователя и предоставляет ему доступ к чату.
    - Если ответ неверный, количество оставшихся попыток уменьшается.
    - При исчерпании попыток пользователь блокируется на заданное время.

## Контрибьютинг

Мы приветствуем вклад сообщества! Если вы хотите улучшить бота или добавить новые функции:

1. Сделайте форк репозитория.
2. Создайте ветку для вашей функции (`git checkout -b feature/NewFeature`).
3. Сделайте коммит ваших изменений (`git commit -am 'Добавлена новая функция'`).
4. Запушьте ветку (`git push origin feature/NewFeature`).
5. Создайте Pull Request.

---

**Примечание:** Убедитесь, что у бота есть необходимые разрешения в чате для ограничения и блокировки пользователей. Для этого бот должен быть администратором чата с соответствующими правами.